# [DB] 락 (LOCK)

---

# 락(Lock)이란?

데이터베이스는 여러 사용자들이 같은 데이터를 동시에 접근하는 상황에서, 데이터의 무결성과 일관성을 지키기 위해 락을 사용한다.

## Lock의 종류

### 공유 락(Shared Lock)

공유 락은 데이터를 변경하지 않는 읽기 명령에 대해 주어지는 락으로 Read Lock이라고도 불리며 Shared의 앞 글자를 따서 주로 S로 표기한다

여러 사용자가 동시에 데이터를 읽어도 데이터의 일관성에는 아무런 영향을 주지 않기 때문에, 공유 락끼리는 동시에 접근이 가능 → 즉, 내가 보고 있는 데이터는 다른 사용자가 볼 수 있지만, 변경할 수는 없음

### 배타 락(Exclusive Lock)

배타 락은 데이터에 변경을 가하는 쓰기 명령들에 대해 주어지는 락으로 Write Lock으로도 불리며, X로 표기한다

배타 락은 이름처럼 다른 세션이 해당 자원에 접근(ex, SELECT, INSERT..) 하는 것을 막는다. 이러한 점에서 베타 락은 멀티 쓰레딩 환경에서, 임계 영역을 안전하게 관리하기 위해 활용되는 뮤텍스와 유사하다고 볼 수 있다.

배타 락은 트랜잭션 동안 유지 → 즉, 읽기와 쓰기가 불가능

# 업데이트 락(Update Lock)

업데이트 락은 데이터를 수정하기 위해 배타 락(X)을 걸기 전, 데드 락을 방지하기 위해 사용되는 락이다

일반적으로 업데이트 락은 UPDATE 쿼리의 필터(WHERE)가 실행되는 과정에서 적용된다

# 내재 락(Intent Lock)

내재 락은 앞서 소개한 락들과 사뭇 다른 기능을 한다

내재 락은 사용자가 요청한 범위에 대한 락(ex, 테이블 락)을 걸 수 있는지 여부를 빠르게 파악하기 위해 사용되는 락이다. 내재 락은 공유 락과 배타 락 앞에 I 기호를 붙인 IS, IX, SIX 등이 있다

---

## Lock의 설정 범위(Level)

- 데이터베이스
    - 데이터베이스 범위의 lock은 전체 데이터베이스를 기준으로 lock 한다. 즉, 1개의 세션만이 DB의 데이터에 접근이 가능하다. 해당 기능은 일반적으로는 사용하지 않는다. 사용하는 때가 있다면 DB의 소프트웨어 버전을 올린다던지 주요한 DB의 업데이트에 사용한다.
- 파일
    - 데이터베이스 파일을 기준으로 lock을 설정한다. 파일 이란 테이블, row 등과 같은 실제 데이터가 쓰여지는 물리적인 저장소다. 해당 범위의 Lock은 잘 사용되지는 않는다.
- 테이블
    - 테이블 수준의 Lock은 테이블을 기준으로 Lock을 설정한다. 이는 테이블의 모든 행을 업데이트 하는 등의 전체 테이블에 영향을 주는 변경을 수행할 때 유용하다. 즉, DDL(create, alter, drop 등) 구문과 함께 사용되며 DDL Lock이라고도 한다.
- 페이지와 블럭
    - 파일의 일부인 페이지와 블록을 기준으로 Lock을 설정한다. 잘 사용되지는 않는다.
- 컬럼
    - 컬럼 기준의 Lock은 컬럼을 기준으로 Lock을 설정할 수 있다. 하지만 이 형식은 Lock 설정 및 해제의 리소스가 많이 들기 때문에 일반적으로 사용되지는 않는다. 지원하는 DBMS도 많지 않다.
- 행(Row)
    - 행 수준의 Lock은 1개의 행(Row)를 기준으로 Lock 설정을 합니다. DML에 대한 Lock으로 가장 일반적으로 사용하는 Lock이다.

---

# 블로킹(Blocking)

블로킹은 Lock간(배타 - 배타, 배타 - 공유)의 경합이 발생하여 특정 Transaction이 작업을 진행하지 못하고 멈춰선 상태를 말한다. 

<img src="https://github.com/GYEONGDONGBAEK/study/assets/122242439/5b2a4d41-ec99-4409-afae-ee0dfdd40466">

공유락 끼리는 블로킹이 발생하지 않지만 배타락은 블로킹을 발생시킨다. 블로킹을 해소하기 위해서는 이전의 트랜잭션이 완료(커밋 OR 롤백)되어야 한다. 뒤에 들어온 트랜잭션은 이전 트랜잭션이 마무리되어야 이후 진행이 가능하다. 이런 경합은 성능에 좋지 않은 영향을 미친다. 따라서 경합을 최소화 할 필요가 있다.

---

# 교착상태(DeadLock)

교착상태는 두 트랜잭션이 각각 Lock을 설정하고 다음 서로의 Lock에 접근하여 값을 얻어오려고 할 때 이미 각각의 트랜잭션에 의해 Lock이 설정되어 있기 때문에 양쪽 트랜잭션 모두 영원히 처리가 되지않게 되는 상태를 말한다.

### Example1

<img src="https://github.com/GYEONGDONGBAEK/study/assets/122242439/b60c3df2-def3-4a4d-8348-b978362cde94">

가장 흔히 떠올릴 수 있는 deadlock 상황. 1번 트랜젝션에서 2번 리소스의 잠금을 획득, 2번 트랜젝션에서는 1번 리소스의 잠금을 획득한 상태다. 이때, 동시에 상대방의 데이터를 엑세스하려고 할때 기존의 Lock이 해제될 때까지 기다리게 되는 상황이다.

### Example2

<img src="https://github.com/GYEONGDONGBAEK/study/assets/122242439/ae2b659d-8ba7-4175-8c67-7038ff30c2c6">

1번 트랜젝션이 공유Lock을 설정하고 Sleep에 빠졌다. 이때 2번 트랜젝션은 배타Lock을 설정하려고 할때, 무기한 기다리게되는 교착상태에 빠지게 된다.